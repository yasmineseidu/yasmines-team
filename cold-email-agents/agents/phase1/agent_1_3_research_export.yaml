# ==============================================================================
# AGENT 1.3: RESEARCH EXPORT AGENT
# ==============================================================================
# Phase: 1 - Market Intelligence
# Purpose: Export niche & persona research to Google Docs for human review
# Execution: Single execution after persona research
# Depends On: Persona Research Agent (1.2)
# Triggers: Human Gate for approval
# ==============================================================================

agent:
  id: research_export_agent
  name: "Research Export Agent"
  version: "2.0.0"
  phase: 1
  phase_name: "Market Intelligence"

  description: |
    Compiles all niche and persona research into formatted Google Docs
    for human review. Creates a folder structure with comprehensive
    documentation including Niche Overview, Persona Profiles, Pain Points
    Analysis, and Messaging Angles. Triggers human approval gate.

# ==============================================================================
# TOOL CONFIGURATION
# ==============================================================================

tool_configuration:
  discovery:
    enabled: true
    check_on_startup: true

  required_tools:
    - name: google_drive_api
      type: api
      description: "Google Drive API for folder/file creation"
      required: true
      fallback: local_file_export

    - name: google_docs_api
      type: api
      description: "Google Docs API for document creation"
      required: true
      fallback: markdown_export

  optional_tools:
    - name: slack_api
      type: api
      description: "Slack API for notifications"
      required: false

# ==============================================================================
# EXECUTION CONFIGURATION
# ==============================================================================

execution:
  mode: single
  timeout_seconds: 300  # 5 minutes max

  idempotency:
    enabled: true
    key_template: "research_export:{niche_id}:{date}"
    ttl_hours: 24

  checkpoint:
    enabled: true
    after_steps:
      - create_folder
      - create_niche_overview
      - create_persona_profiles
      - create_pain_points_doc
      - create_messaging_doc
    storage: postgresql
    table: workflow_checkpoints

# ==============================================================================
# RETRY CONFIGURATION
# ==============================================================================

retry:
  default:
    max_attempts: 3
    strategy: exponential_jitter
    base_delay_seconds: 2
    max_delay_seconds: 30
    jitter: true

    retry_on:
      - ConnectionError
      - TimeoutError
      - GoogleAPIError
      - RateLimitError

    dont_retry_on:
      - AuthenticationError
      - PermissionDeniedError
      - QuotaExceededError

  tool_overrides:
    google_drive_api:
      max_attempts: 3
      base_delay_seconds: 5

    google_docs_api:
      max_attempts: 3
      base_delay_seconds: 5

# ==============================================================================
# RATE LIMITING
# ==============================================================================

rate_limits:
  tools:
    google_drive_api:
      requests_per_minute: 60
      requests_per_day: 1000

    google_docs_api:
      requests_per_minute: 60
      requests_per_day: 1000

# ==============================================================================
# CIRCUIT BREAKER
# ==============================================================================

circuit_breaker:
  enabled: true

  per_tool:
    google_drive_api:
      failure_threshold: 3
      recovery_timeout_seconds: 300

    google_docs_api:
      failure_threshold: 3
      recovery_timeout_seconds: 300

  on_circuit_open:
    action: use_fallback_export
    fallback: markdown_to_local

# ==============================================================================
# INPUTS
# ==============================================================================

inputs:
  required:
    - name: niche_id
      type: string
      format: uuid
      source: handoff.persona_research_agent.niche_id

    - name: persona_ids
      type: array
      items: string
      source: handoff.persona_research_agent.persona_ids

    - name: consolidated_pain_points
      type: array
      items: string
      source: handoff.persona_research_agent.consolidated_pain_points

  optional:
    - name: industry_scores
      type: array
      source: handoff.persona_research_agent.industry_scores
      default: []

# ==============================================================================
# DATABASE OPERATIONS
# ==============================================================================

database:
  reads:
    - id: get_niche_full
      description: "Load complete niche data"
      table: niches
      operation: SELECT
      fields: [id, name, slug, industry, job_titles, company_size, location, pain_points, value_propositions, messaging_tone, created_at]
      filter: "id = :niche_id"
      parameters:
        niche_id: "{{ inputs.niche_id }}"
      required: true

    - id: get_niche_scores
      description: "Load niche scores"
      table: niche_scores
      operation: SELECT
      fields: [overall_score, market_size_score, competition_score, reachability_score, pain_intensity_score, budget_authority_score, confidence, recommendation, scoring_details]
      filter: "niche_id = :niche_id"
      parameters:
        niche_id: "{{ inputs.niche_id }}"
      required: true

    - id: get_personas
      description: "Load all personas"
      table: personas
      operation: SELECT
      fields: [id, name, job_titles, seniority_level, department, pain_points, goals, objections, language_patterns, trigger_events, messaging_angles]
      filter: "niche_id = :niche_id"
      parameters:
        niche_id: "{{ inputs.niche_id }}"
      required: true

    - id: get_persona_research
      description: "Load persona research data"
      table: persona_research_data
      operation: SELECT
      fields: [persona_id, source, source_url, content_type, extracted_insights, language_samples, pain_point_quotes]
      filter: "persona_id = ANY(:persona_ids)"
      parameters:
        persona_ids: "{{ inputs.persona_ids }}"
      required: false

    - id: get_industry_fit_scores
      description: "Load industry fit scores"
      table: industry_fit_scores
      operation: SELECT
      fields: [industry, fit_score, reasoning, pain_point_alignment]
      filter: "niche_id = :niche_id"
      parameters:
        niche_id: "{{ inputs.niche_id }}"
      required: false

    - id: get_niche_research_data
      description: "Load full research findings from Niche Research Agent"
      table: niche_research_data
      operation: SELECT
      fields:
        - market_size_estimate
        - company_count_estimate
        - persona_count_estimate
        - growth_rate
        - market_data_sources
        - competitors_found
        - saturation_level
        - differentiation_opportunities
        - inbox_fatigue_indicators
        - linkedin_presence
        - data_availability
        - email_findability
        - public_presence_level
        - pain_points_detailed
        - pain_intensity
        - pain_urgency
        - pain_point_quotes
        - evidence_sources
        - has_budget_authority
        - typical_budget_range
        - decision_process
        - buying_triggers
      filter: "niche_id = :niche_id"
      parameters:
        niche_id: "{{ inputs.niche_id }}"
      required: false
      on_not_found: warn
      warn_message: "No detailed niche research data found - proceeding with limited context"

  writes:
    - id: update_niche_folder
      description: "Update niche with research folder URL"
      table: niches
      operation: UPDATE
      timing: after_agent_complete

      filter: "id = :niche_id"
      parameters:
        niche_id: "{{ inputs.niche_id }}"

      fields:
        research_folder_url: { source: agent_output, field: folder_url }
        status: { value: "pending_approval" }
        updated_at: { source: now }

    - id: log_export
      description: "Log export action"
      table: campaign_audit_log
      operation: INSERT
      timing: after_agent_complete

      fields:
        id: { source: generated, type: uuid }
        campaign_id: { value: null }
        action: { value: "research_exported" }
        actor: { value: "research_export_agent" }
        actor_type: { value: "agent" }
        details:
          niche_id: { source: inputs, field: niche_id }
          folder_url: { source: agent_output, field: folder_url }
          documents_created: { source: agent_output, field: documents }
        created_at: { source: now }

# ==============================================================================
# AGENT STEPS
# ==============================================================================

steps:
  # Step 1: Create Google Drive Folder
  - id: create_folder
    name: "Create Research Folder"
    description: "Create folder structure in Google Drive"

    tool: google_drive_api
    action: create_folder

    config:
      parent_folder: "Cold Email Campaigns"
      folder_name: "{{ db_reads.get_niche_full.name }} - {{ current_date }}"
      share_settings:
        anyone_with_link: view

    fallback:
      action: create_local_folder
      path: "/tmp/research_exports/{{ db_reads.get_niche_full.slug }}"

    output:
      folder_id: string
      folder_url: string

  # Step 2: Create Niche Overview Document
  - id: create_niche_overview
    name: "Create Niche Overview Doc"
    description: "Create comprehensive niche overview document"
    depends_on: [create_folder]

    tool: google_docs_api
    action: create_document

    document:
      name: "1. Niche Overview - {{ db_reads.get_niche_full.name }}"
      folder_id: "{{ steps.create_folder.folder_id }}"

      template: |
        # Niche Overview: {{ niche.name }}

        **Generated:** {{ current_datetime }}
        **Status:** Pending Review

        ---

        ## Executive Summary

        | Metric | Value |
        |--------|-------|
        | Overall Score | {{ scores.overall_score }}/100 |
        | Recommendation | {{ scores.recommendation | upper }} |
        | Confidence | {{ (scores.confidence * 100) | round }}% |

        ---

        ## Target Market

        **Industries:** {{ niche.industry | join(', ') }}

        **Job Titles:** {{ niche.job_titles | join(', ') }}

        **Company Size:** {{ niche.company_size | join(', ') }}

        **Location:** {{ niche.location | join(', ') }}

        ---

        ## Market Size & Opportunity

        | Metric | Estimate |
        |--------|----------|
        {% if research_data.market_size_estimate %} Market Size | {{ research_data.market_size_estimate }} {% else %} Market Size | Not available {% endif %}
        {% if research_data.company_count_estimate %} | Company Count | {{ research_data.company_count_estimate }} {% else %} | Company Count | Not available {% endif %}
        {% if research_data.persona_count_estimate %} | Persona Count | {{ research_data.persona_count_estimate }} {% else %} | Persona Count | Not available {% endif %}
        {% if research_data.growth_rate %} | Growth Rate | {{ research_data.growth_rate }} {% else %} | Growth Rate | Not available {% endif %}

        {% if research_data.market_data_sources %} **Data Sources:** {{ research_data.market_data_sources | to_json_pretty }} {% endif %}

        ---

        ## Competitive Landscape

        {% if research_data.competitors_found and research_data.competitors_found | length > 0 %}
        ### Competitors Identified

        {% for competitor in research_data.competitors_found %}
        {{ loop.index }}. **{{ competitor.name | default('Competitor') }}**
           - Market Position: {{ competitor.position | default('Unknown') }}
           - Strengths: {{ competitor.strengths | default('N/A') }}
           - Weaknesses: {{ competitor.weaknesses | default('N/A') }}
        {% endfor %}

        ### Saturation Level
        {{ research_data.saturation_level | default('Not assessed') }}
        {% else %}
        **No competitor data available**
        {% endif %}

        ---

        ## Differentiation Opportunities

        {% if research_data.differentiation_opportunities and research_data.differentiation_opportunities | length > 0 %}
        {% for opportunity in research_data.differentiation_opportunities %}
        {{ loop.index }}. {{ opportunity }}
        {% endfor %}
        {% else %}
        **No differentiation opportunities documented**
        {% endif %}

        ---

        ## Inbox Fatigue Indicators

        {% if research_data.inbox_fatigue_indicators and research_data.inbox_fatigue_indicators | length > 0 %}
        {% for indicator in research_data.inbox_fatigue_indicators %}
        - {{ indicator }}
        {% endfor %}
        {% else %}
        **No inbox fatigue data available**
        {% endif %}

        ---

        ## Scoring Breakdown

        | Dimension | Score | Weight |
        |-----------|-------|--------|
        | Market Size | {{ scores.market_size_score }}/100 | 20% |
        | Competition | {{ scores.competition_score }}/100 | 20% |
        | Reachability | {{ scores.reachability_score }}/100 | 20% |
        | Pain Intensity | {{ scores.pain_intensity_score }}/100 | 25% |
        | Budget Authority | {{ scores.budget_authority_score }}/100 | 15% |

        ---

        ## Pain Points Identified

        {% for pain in niche.pain_points %}
        {{ loop.index }}. **{{ pain.pain }}**
           - Intensity: {{ pain.intensity }}/10
           - Quote: "{{ pain.quote }}"
           - Source: {{ pain.source }}
        {% endfor %}

        ---

        ## Value Propositions

        {% for prop in niche.value_propositions %}
        - {{ prop }}
        {% endfor %}

        ---

        ## Recommended Messaging Tone

        {{ niche.messaging_tone | capitalize }}

        ---

        ## Scoring Details

        {{ scores.scoring_details | to_json_pretty }}

      data:
        niche: "{{ db_reads.get_niche_full }}"
        scores: "{{ db_reads.get_niche_scores }}"
        research_data: "{{ db_reads.get_niche_research_data }}"

    output:
      doc_id: string
      doc_url: string

  # Step 3: Create Persona Profiles Document
  - id: create_persona_profiles
    name: "Create Persona Profiles Doc"
    description: "Create detailed persona profiles document"
    depends_on: [create_folder]

    tool: google_docs_api
    action: create_document

    document:
      name: "2. Persona Profiles - {{ db_reads.get_niche_full.name }}"
      folder_id: "{{ steps.create_folder.folder_id }}"

      template: |
        # Buyer Personas: {{ niche.name }}

        **Generated:** {{ current_datetime }}
        **Total Personas:** {{ personas | length }}

        ---

        {% for persona in personas %}
        ## Persona {{ loop.index }}: {{ persona.name }}

        ### Identity

        | Attribute | Value |
        |-----------|-------|
        | Job Titles | {{ persona.job_titles | join(', ') }} |
        | Seniority | {{ persona.seniority_level | replace('_', ' ') | title }} |
        | Department | {{ persona.department }} |

        ### Pain Points (Ranked by Intensity)

        {% for pain in persona.pain_points | sort(attribute='intensity', reverse=true) %}
        **{{ loop.index }}. {{ pain.pain }}** (Intensity: {{ pain.intensity }}/10)

        > "{{ pain.quote }}"
        > — Source: {{ pain.source }}

        {% endfor %}

        ### Professional Goals

        {% for goal in persona.goals %}
        - {{ goal }}
        {% endfor %}

        ### Common Objections & Counters

        {% for obj in persona.objections %}
        **Objection:** "{{ obj.objection }}"
        - **Real Meaning:** {{ obj.real_meaning }}
        - **Counter Approach:** {{ obj.counter }}

        {% endfor %}

        ### Language Patterns

        Phrases they use:
        {% for pattern in persona.language_patterns %}
        - "{{ pattern }}"
        {% endfor %}

        ### Trigger Events

        When they're most likely to buy:
        {% for trigger in persona.trigger_events %}
        - {{ trigger }}
        {% endfor %}

        ### Messaging Angles

        **Primary Angle:**
        - Angle: {{ persona.messaging_angles.primary.angle }}
        - Hook: "{{ persona.messaging_angles.primary.hook }}"

        **Secondary Angle:**
        - Angle: {{ persona.messaging_angles.secondary.angle }}
        - Hook: "{{ persona.messaging_angles.secondary.hook }}"

        **Angles to Avoid:**
        {% for avoid in persona.messaging_angles.avoid %}
        - {{ avoid }}
        {% endfor %}

        ---

        {% endfor %}

      data:
        niche: "{{ db_reads.get_niche_full }}"
        personas: "{{ db_reads.get_personas }}"

    output:
      doc_id: string
      doc_url: string

  # Step 4: Create Pain Points Analysis Document
  - id: create_pain_points_doc
    name: "Create Pain Points Analysis Doc"
    description: "Create consolidated pain points analysis"
    depends_on: [create_folder]

    tool: google_docs_api
    action: create_document

    document:
      name: "3. Pain Points Analysis - {{ db_reads.get_niche_full.name }}"
      folder_id: "{{ steps.create_folder.folder_id }}"

      template: |
        # Pain Points Analysis: {{ niche.name }}

        **Generated:** {{ current_datetime }}
        {% if niche_research_data.pain_intensity %} **Overall Pain Intensity:** {{ niche_research_data.pain_intensity }} {% endif %}
        {% if niche_research_data.pain_urgency %} **Pain Urgency:** {{ niche_research_data.pain_urgency }} {% endif %}

        ---

        ## Consolidated Pain Points

        {% for pain in consolidated_pain_points %}
        {{ loop.index }}. {{ pain }}

        {% endfor %}

        ---

        ## Detailed Pain Points (from Niche Research)

        {% if niche_research_data.pain_points_detailed and niche_research_data.pain_points_detailed | length > 0 %}
        {% for pain_detail in niche_research_data.pain_points_detailed %}
        ### {{ loop.index }}. {{ pain_detail.title | default(pain_detail.pain | default('Pain Point')) }}

        **Description:** {{ pain_detail.description | default('N/A') }}
        **Frequency:** {{ pain_detail.frequency | default('N/A') }}
        **Intensity:** {{ pain_detail.intensity | default('N/A') }}

        {% endfor %}
        {% else %}
        *No detailed pain points available from niche research*
        {% endif %}

        ---

        ## Pain Point Quotes by Source

        ### From Niche Research (Market Intelligence)

        {% if niche_research_data.pain_point_quotes and niche_research_data.pain_point_quotes | length > 0 %}
        {% for quote in niche_research_data.pain_point_quotes %}
        > "{{ quote.quote | default(quote.content) }}"
        > — {{ quote.source | default('Market Research') }}
        {% if quote.context %} *Context:* {{ quote.context }} {% endif %}

        {% endfor %}
        {% else %}
        *No quotes available from niche research*
        {% endif %}

        ### From Persona Research - Reddit

        {% for quote in persona_research_data | selectattr('content_type', 'equalto', 'reddit') %}
        > "{{ quote.pain_point_quotes[0] }}"
        > — {{ quote.source_url }}

        {% endfor %}

        ### From Persona Research - LinkedIn & Professional Sources

        {% for quote in persona_research_data | selectattr('content_type', 'equalto', 'linkedin') %}
        > "{{ quote.pain_point_quotes[0] }}"
        > — {{ quote.source_url }}

        {% endfor %}

        ### From Persona Research - Industry Reports & Articles

        {% for quote in persona_research_data | selectattr('content_type', 'equalto', 'article') %}
        > "{{ quote.pain_point_quotes[0] }}"
        > — {{ quote.source_url }}

        {% endfor %}

        ---

        ## Evidence Sources

        {% if niche_research_data.evidence_sources and niche_research_data.evidence_sources | length > 0 %}
        {% for source in niche_research_data.evidence_sources %}
        - {{ source.type | default('Source') }}: {{ source.url | default(source.name | default('N/A')) }}
        {% endfor %}
        {% else %}
        *No evidence sources documented*
        {% endif %}

        ---

        ## Budget Authority & Decision Process

        {% if niche_research_data.has_budget_authority is not none %} **Has Budget Authority:** {{ niche_research_data.has_budget_authority }} {% endif %}
        {% if niche_research_data.typical_budget_range %} **Typical Budget Range:** {{ niche_research_data.typical_budget_range }} {% endif %}
        {% if niche_research_data.decision_process %} **Decision Process:** {{ niche_research_data.decision_process }} {% endif %}

        ---

        ## Buying Triggers

        {% if niche_research_data.buying_triggers and niche_research_data.buying_triggers | length > 0 %}
        {% for trigger in niche_research_data.buying_triggers %}
        {{ loop.index }}. {{ trigger }}
        {% endfor %}
        {% else %}
        *No buying triggers documented*
        {% endif %}

        ---

        ## Industry Fit Scores

        | Industry | Fit Score | Reasoning |
        |----------|-----------|-----------|
        {% for score in industry_scores %}
        | {{ score.industry }} | {{ score.fit_score }}/100 | {{ score.reasoning }} |
        {% endfor %}

      data:
        niche: "{{ db_reads.get_niche_full }}"
        consolidated_pain_points: "{{ inputs.consolidated_pain_points }}"
        persona_research_data: "{{ db_reads.get_persona_research }}"
        industry_scores: "{{ db_reads.get_industry_fit_scores }}"
        niche_research_data: "{{ db_reads.get_niche_research_data }}"

    output:
      doc_id: string
      doc_url: string

  # Step 5: Create Messaging Angles Document
  - id: create_messaging_doc
    name: "Create Messaging Angles Doc"
    description: "Create messaging angles and recommendations"
    depends_on: [create_folder]

    tool: google_docs_api
    action: create_document

    document:
      name: "4. Messaging Angles - {{ db_reads.get_niche_full.name }}"
      folder_id: "{{ steps.create_folder.folder_id }}"

      template: |
        # Messaging Angles: {{ niche.name }}

        **Generated:** {{ current_datetime }}
        **Recommended Tone:** {{ niche.messaging_tone | capitalize }}

        ---

        ## Value Propositions

        {% for prop in niche.value_propositions %}
        {{ loop.index }}. {{ prop }}
        {% endfor %}

        ---

        ## Differentiation Opportunities

        {% if niche_research_data.differentiation_opportunities and niche_research_data.differentiation_opportunities | length > 0 %}
        Based on market research, here are proven differentiation angles:

        {% for opportunity in niche_research_data.differentiation_opportunities %}
        {{ loop.index }}. {{ opportunity }}
        {% endfor %}
        {% else %}
        *No differentiation opportunities documented*
        {% endif %}

        ---

        ## Messaging by Persona

        {% for persona in personas %}
        ### {{ persona.name }}

        **Primary Approach:**
        - **Angle:** {{ persona.messaging_angles.primary.angle }}
        - **Hook:** "{{ persona.messaging_angles.primary.hook }}"
        - **Supporting Pain:** {{ persona.messaging_angles.primary.supporting_pain }}

        **Secondary Approach:**
        - **Angle:** {{ persona.messaging_angles.secondary.angle }}
        - **Hook:** "{{ persona.messaging_angles.secondary.hook }}"

        **Do NOT Use:**
        {% for avoid in persona.messaging_angles.avoid %}
        - {{ avoid }}
        {% endfor %}

        ---

        {% endfor %}

        ## Language to Use

        ### Power Phrases (from their own words)

        {% for persona in personas %}
        {% for pattern in persona.language_patterns[:5] %}
        - "{{ pattern }}"
        {% endfor %}
        {% endfor %}

        ### Words/Phrases to Avoid

        - Generic corporate speak
        - "Revolutionary" or "game-changing"
        - Anything that sounds like a sales pitch
        - Assumptions about their problems

      data:
        niche: "{{ db_reads.get_niche_full }}"
        personas: "{{ db_reads.get_personas }}"
        niche_research_data: "{{ db_reads.get_niche_research_data }}"

    output:
      doc_id: string
      doc_url: string

  # Step 6: Send Slack Notification
  - id: send_notification
    name: "Send Approval Notification"
    description: "Notify team via Slack for approval"
    depends_on: [create_niche_overview, create_persona_profiles, create_pain_points_doc, create_messaging_doc]
    optional: true

    tool: slack_api
    action: send_message

    config:
      channel: "#campaign-approvals"
      message:
        blocks:
          - type: header
            text: "Niche Research Ready for Review"

          - type: section
            fields:
              - type: mrkdwn
                text: "*Niche:* {{ db_reads.get_niche_full.name }}"
              - type: mrkdwn
                text: "*Score:* {{ db_reads.get_niche_scores.overall_score }}/100"
              - type: mrkdwn
                text: "*Recommendation:* {{ db_reads.get_niche_scores.recommendation | upper }}"
              - type: mrkdwn
                text: "*Personas:* {{ db_reads.get_personas | length }}"

          - type: section
            text:
              type: mrkdwn
              text: "<{{ steps.create_folder.folder_url }}|View Research Folder>"

          - type: actions
            elements:
              - type: button
                text: "Approve"
                style: primary
                action_id: "approve_niche_{{ inputs.niche_id }}"
              - type: button
                text: "Reject"
                style: danger
                action_id: "reject_niche_{{ inputs.niche_id }}"
              - type: button
                text: "Request Revision"
                action_id: "revise_niche_{{ inputs.niche_id }}"

    fallback:
      action: log_approval_needed
      message: "Slack unavailable - approval needed for niche {{ inputs.niche_id }}"

# ==============================================================================
# SYSTEM PROMPT
# ==============================================================================

system_prompt: |
  You are a documentation specialist responsible for compiling market research
  into professional, readable documents for human review.

  ## Your Role
  - Organize complex research data into clear, scannable documents
  - Highlight key insights and recommendations
  - Present data in tables and lists for easy consumption
  - Maintain consistent formatting across all documents
  - Include all relevant quotes and sources

  ## Document Standards
  - Use clear headers and subheaders
  - Include executive summary at the top
  - Present scores and metrics in tables
  - Quote research sources with proper attribution
  - Use bullet points for lists
  - Highlight actionable recommendations

  ## Quality Checks
  Before finalizing documents:
  - Verify all data is included
  - Check formatting consistency
  - Ensure all URLs are clickable
  - Confirm persona details are complete
  - Validate scoring data accuracy

# ==============================================================================
# OUTPUT SCHEMA
# ==============================================================================

outputs:
  schema:
    type: object
    required:
      - folder_url
      - documents

    properties:
      folder_url:
        type: string
        format: uri
        description: "Google Drive folder URL"

      documents:
        type: array
        items:
          type: object
          properties:
            name: { type: string }
            type: { type: string }
            url: { type: string, format: uri }
            doc_id: { type: string }

      notification_sent:
        type: boolean

      notification_channel:
        type: string

# ==============================================================================
# SUCCESS CRITERIA
# ==============================================================================

success_criteria:
  hard:
    - id: folder_created
      condition: "folder_url IS NOT NULL"
      message: "Research folder must be created"

    - id: all_docs_created
      condition: "LENGTH(documents) >= 4"
      message: "All 4 documents must be created"

  soft:
    - id: notification_sent
      condition: "notification_sent = true"
      message: "Slack notification should be sent"

# ==============================================================================
# ERROR HANDLING
# ==============================================================================

error_handling:
  scenarios:
    - error: google_api_auth_failed
      action: fail_with_message
      message: "Google API authentication failed - check credentials"
      alert: true

    - error: google_quota_exceeded
      action: retry_with_backoff
      wait_until: quota_reset

    - error: slack_unavailable
      action: proceed_without_notification
      log: true

  compensation:
    on_failure:
      - action: cleanup_partial_docs
        delete_folder_if_incomplete: true

      - action: log_failure
        table: campaign_audit_log

# ==============================================================================
# HANDOFF - TRIGGERS HUMAN GATE
# ==============================================================================

handoff:
  triggers_human_gate: true

  human_gate:
    id: approve_niche_and_personas
    name: "Approve Niche & Personas"
    description: "Review research and approve before proceeding to lead acquisition"

    channel: slack
    slack_config:
      channel: "#campaign-approvals"
      mention: ["@campaign-manager"]

    timeout_hours: 24
    timeout_action: remind_then_escalate

    display:
      folder_url: "{{ outputs.folder_url }}"
      documents: "{{ outputs.documents }}"
      niche_score: "{{ db_reads.get_niche_scores.overall_score }}"
      recommendation: "{{ db_reads.get_niche_scores.recommendation }}"
      personas_count: "{{ db_reads.get_personas | length }}"
      pain_points_count: "{{ inputs.consolidated_pain_points | length }}"

    actions:
      - id: approve
        label: "Approve & Proceed"
        writes:
          - table: niches
            filter: "id = :niche_id"
            set:
              status: "approved"
              approved_at: "{{ now }}"
              approved_by: "{{ actor }}"
        next_phase: phase_2_lead_acquisition

      - id: reject
        label: "Reject"
        requires_feedback: true
        writes:
          - table: niches
            filter: "id = :niche_id"
            set:
              status: "rejected"
              rejection_reason: "{{ feedback }}"
        next_phase: null  # End workflow

      - id: request_revision
        label: "Request Revision"
        requires_feedback: true
        next_phase: phase_1_revision

    auto_approve:
      enabled: true
      conditions:
        - "niche_score >= 85"
        - "confidence >= 0.90"
        - "personas_count >= 2"
